<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Extending Autograd • torchr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Extending Autograd">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">torchr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/extending-autograd.html">Extending Autograd</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/dfalbel/torch">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="extending-autograd_files/header-attrs-2.1.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Extending Autograd</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/dfalbel/torch/blob/master/vignettes/extending-autograd.Rmd"><code>vignettes/extending-autograd.Rmd</code></a></small>
      <div class="hidden name"><code>extending-autograd.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(torchr)</span></code></pre></div>
<p>Adding operations to autograd requires implementing a new <code>autograd_function</code> for each operation. Recall that <code>autograd_functions</code>s are what <code>autograd</code> uses to compute the results and gradients, and encode the operation history. Every new function requires you to implement 2 methods:</p>
<ul>
<li><p><code>forward()</code> - the code that performs the operation. It can take as many arguments as you want, with some of them being optional, if you specify the default values. All kinds of R objects are accepted here. Tensor arguments that track history (i.e., with <code>requires_grad=TRUE</code>) will be converted to ones that don’t track history before the call, and their use will be registered in the graph. Note that this logic won’t traverse lists or any other data structures and will only consider Tensor’s that are direct arguments to the call. You can return either a single Tensor output, or a list of <code>Tensor</code>s if there are multiple outputs. Also, please refer to the docs of <code>autograd_function</code> to find descriptions of useful methods that can be called only from <code>forward()</code>.</p></li>
<li><p><code>backward()</code> - gradient formula. It will be given as many Tensor arguments as there were outputs, with each of them representing gradient w.r.t. that output. It should return as many <code>Tensor</code>s as there were <code>Tensor's</code> that required gradients in <code>forward</code>, with each of them containing the gradient w.r.t. its corresponding input.</p></li>
</ul>
<div id="note" class="section level2">
<h2 class="hasAnchor">
<a href="#note" class="anchor"></a>Note</h2>
<p>It’s the user’s responsibility to use the special functions in the forward’s <code>ctx</code> properly in order to ensure that the new <code>autograd_function</code> works properly with the autograd engine.</p>
<ul>
<li><p><code>save_for_backward()</code> must be used when saving input or ouput of the forward to be used later in the backward.</p></li>
<li><p><code>mark_dirty()</code> must be used to mark any input that is modified inplace by the forward function.</p></li>
<li><p><code>mark_non_differentiable()</code> must be used to tell the engine if an output is not differentiable.</p></li>
</ul>
</div>
<div id="examples" class="section level2">
<h2 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h2>
<p>Below you can find code for a linear function:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>linear &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograd_function.html">autograd_function</a></span>(</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="dt">forward =</span> <span class="cf">function</span>(ctx, input, weight, <span class="dt">bias =</span> <span class="ot">NULL</span>) {</span>
<span id="cb2-3"><a href="#cb2-3"></a>    ctx<span class="op">$</span><span class="kw">save_for_backward</span>(<span class="dt">input =</span> input, <span class="dt">weight =</span> weight, <span class="dt">bias =</span> bias)</span>
<span id="cb2-4"><a href="#cb2-4"></a>    output &lt;-<span class="st"> </span>input<span class="op">$</span><span class="kw">mm</span>(weight<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>())</span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(bias))</span>
<span id="cb2-6"><a href="#cb2-6"></a>      output &lt;-<span class="st"> </span>output <span class="op">+</span><span class="st"> </span>bias<span class="op">$</span><span class="kw">unsqueeze</span>(<span class="dv">0</span>)<span class="op">$</span><span class="kw">expand_as</span>(output)</span>
<span id="cb2-7"><a href="#cb2-7"></a>    </span>
<span id="cb2-8"><a href="#cb2-8"></a>    output</span>
<span id="cb2-9"><a href="#cb2-9"></a>  },</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="dt">backward =</span> <span class="cf">function</span>(ctx, grad_output) {</span>
<span id="cb2-11"><a href="#cb2-11"></a>    </span>
<span id="cb2-12"><a href="#cb2-12"></a>    s &lt;-<span class="st"> </span>ctx<span class="op">$</span>saved_variables</span>
<span id="cb2-13"><a href="#cb2-13"></a>    </span>
<span id="cb2-14"><a href="#cb2-14"></a>    grads &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb2-15"><a href="#cb2-15"></a>      <span class="dt">input =</span> <span class="ot">NULL</span>,</span>
<span id="cb2-16"><a href="#cb2-16"></a>      <span class="dt">weight =</span> <span class="ot">NULL</span>,</span>
<span id="cb2-17"><a href="#cb2-17"></a>      <span class="dt">bias =</span> <span class="ot">NULL</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>    )</span>
<span id="cb2-19"><a href="#cb2-19"></a>    </span>
<span id="cb2-20"><a href="#cb2-20"></a>    <span class="cf">if</span> (ctx<span class="op">$</span>needs_input_grad<span class="op">$</span>input)</span>
<span id="cb2-21"><a href="#cb2-21"></a>      grads<span class="op">$</span>input &lt;-<span class="st"> </span>grad_output<span class="op">$</span><span class="kw">mm</span>(s<span class="op">$</span>weight)</span>
<span id="cb2-22"><a href="#cb2-22"></a>    </span>
<span id="cb2-23"><a href="#cb2-23"></a>    <span class="cf">if</span> (ctx<span class="op">$</span>needs_input_grad<span class="op">$</span>weight)</span>
<span id="cb2-24"><a href="#cb2-24"></a>      grads<span class="op">$</span>weight &lt;-<span class="st"> </span>grad_output<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/t.html">t</a></span>()<span class="op">$</span><span class="kw">mm</span>(s<span class="op">$</span>input)</span>
<span id="cb2-25"><a href="#cb2-25"></a>    </span>
<span id="cb2-26"><a href="#cb2-26"></a>    <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(s<span class="op">$</span>bias) <span class="op">&amp;&amp;</span><span class="st"> </span>ctx<span class="op">$</span>needs_input_grad<span class="op">$</span>bias)</span>
<span id="cb2-27"><a href="#cb2-27"></a>      grads<span class="op">$</span>bias &lt;-<span class="st"> </span>grad_output<span class="op">$</span><span class="kw"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="dt">dim =</span> <span class="dv">0</span>)</span>
<span id="cb2-28"><a href="#cb2-28"></a>    </span>
<span id="cb2-29"><a href="#cb2-29"></a>    grads</span>
<span id="cb2-30"><a href="#cb2-30"></a>  }</span>
<span id="cb2-31"><a href="#cb2-31"></a>)</span></code></pre></div>
<p>Here, we give an additional example of a function that is parametrized by non-Tensor arguments:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>mul_constant &lt;-<span class="st"> </span><span class="kw"><a href="../reference/autograd_function.html">autograd_function</a></span>(</span>
<span id="cb3-2"><a href="#cb3-2"></a>  <span class="dt">forward =</span> <span class="cf">function</span>(ctx, tensor, constant) {</span>
<span id="cb3-3"><a href="#cb3-3"></a>    ctx<span class="op">$</span><span class="kw">save_for_backward</span>(<span class="dt">constant =</span> constant)</span>
<span id="cb3-4"><a href="#cb3-4"></a>    tensor <span class="op">*</span><span class="st"> </span>constant</span>
<span id="cb3-5"><a href="#cb3-5"></a>  },</span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="dt">backward =</span> <span class="cf">function</span>(ctx, grad_output) {</span>
<span id="cb3-7"><a href="#cb3-7"></a>    v &lt;-<span class="st"> </span>ctx<span class="op">$</span>saved_variables</span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(</span>
<span id="cb3-9"><a href="#cb3-9"></a>      <span class="dt">tensor =</span> grad_output <span class="op">*</span><span class="st"> </span>v<span class="op">$</span>constant</span>
<span id="cb3-10"><a href="#cb3-10"></a>    )</span>
<span id="cb3-11"><a href="#cb3-11"></a>  }</span>
<span id="cb3-12"><a href="#cb3-12"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>x &lt;-<span class="st"> </span><span class="kw">torch_tensor</span>(<span class="dv">1</span>, <span class="dt">requires_grad =</span> <span class="ot">TRUE</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a>o &lt;-<span class="st"> </span><span class="kw">mul_constant</span>(x, <span class="dv">2</span>)</span>
<span id="cb4-3"><a href="#cb4-3"></a>o<span class="op">$</span><span class="kw">backward</span>()</span>
<span id="cb4-4"><a href="#cb4-4"></a>x<span class="op">$</span><span class="kw">grad</span>()</span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co">#&gt; torch_tensor </span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt;  2</span></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co">#&gt; [ CPUFloatType{1} ]</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#note">Note</a></li>
      <li><a href="#examples">Examples</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falbel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
